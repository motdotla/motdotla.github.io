---
layout: default
title: "Docker with Rails"
---

<time>2016-05-19</time>

<h2>Docker with Rails</h2>

<img src="/images/docker-with-rails.png" />

<p>
  In this article I show you how to get a Rails application working with 
  Docker.
</p>

<h3>Install Docker Toolbox</h3>

<p>
  Begin by installing the <a href="https://www.docker.com/products/docker-toolbox">Docker Toolbox</a>
  on Mac OSX. Download it and follow the installer steps.
</p>

<p>
  Once it is done, open <strong><code>Applications/Docker/Docker Quickstart Terminal</code></strong>
</p>

<p>
  It comes with everything you need - Docker Client, Docker Machine, 
  Docker Compose, Docker Kitematic, and VirtualBox.
</p>

<p>
  That will take a little time. If it completes successfully, you will see the
  Docker Whale - "Moby Dock" :)
</p>

<p>
  Type <code>docker</code> to see all the available commands to you.
</p>

<p>
  Note: if you see instructions for Boot2Docker installations, ignore those. It
  is an old method of installing Docker.
</p>

<h3>Hello World in a container</h3>

<code><pre>
docker run busybox echo hello world
</pre></code>

<p>
  It will pull the <code>busyboxy</code> container from the registry and run it.
</p>

<p>
  That's it! You just ran your first docker container.
</p>

<p>
  You can see the container by running:
</p>

<code><pre>
docker ps --all
</pre></code>

<p>
  You can see the image used for the container by typing:
</p>

<code><pre>
docker images
</pre></code>

<p>
  You can remove a container by providing its CONTAINER ID to the <code>rm</code>
  command.
</p>

<code><pre>
docker rm a700ab83e84f
</pre></code>

<p>
  Then as long as no running or stopped containers are using the image, you can
  delete the image too.
</p>

<code><pre>
docker rmi busybox
</pre></code>

<h3>Getting a terminal session</h3>

<p>
  Ok, now let's actually login and get a terminal session. Let's use ubuntu.
</p>

<code><pre>
docker run -tty --interactive ubuntu:14.04
</pre></code>

<h3>Running a server as a daemon</h3>

<p>
  Ok, now let's run an actual server.
</p>

<code><pre>
docker run --detach --publish 1234:1234 python:2.7 python -m SimpleHTTPServer 1234
</pre></code>

<p>
  Then connect to that container by:
</p>

<code><pre>
docker exec -ti CONTAINER_ID
</pre></code>

<p>
  Then get the ip address by doing:
</p>

<code><pre>
docker-machine ip
</pre></code>

<p>
  And finally visit: THE_IP:1234
</p>

<h3>Create your own Dockerfile</h3>

<code><pre>
# === 1 ===
FROM phusion/passenger-ruby21:0.9.18
MAINTAINER Mot "mot@mot.la"

# Set correct environment variables
ENV HOME /root

# Use baseimage-docker's init process
CMD ["/sbin/my_init"]

# === 2 ===
# Start Nginx / Passenger
RUN rm -f /etc/service/nginx/down

# === 3 ====
# Remove the default site
RUN rm /etc/nginx/sites-enabled/default

# Add the nginx info
ADD nginx.conf /etc/nginx/sites-enabled/webapp.conf

# === 4 ===
# Prepare folders
RUN mkdir /home/app/webapp

# === 5 ===
# Run Bundle in a cache efficient way
WORKDIR /tmp
ADD Gemfile /tmp/
ADD Gemfile.lock /tmp/
RUN bundle install

# === 6 ===
# Add the rails app
ADD . /home/app/webapp

# === 7 ===
# Run migrations
WORKDIR /home/app/webapp
RUN bundle exec rake db:create db:migrate

# Clean up APT when done
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
</pre></code>


<p>
  And create an nginx.conf file.
</p>

<code><pre>
server {
	listen 80;
	server_name example.com;
	root /home/app/webapp/public;

	passenger_enabled on;
	passenger_user app;

	passenger_ruby /usr/bin/ruby2.1;
}
</pre></code>

<p>
  Then run the command:
</p>

<code><pre>
docker build --tag webapp .
</pre></code>

<p>
  Then check it in images:
</p>

<code><pre>
docker images
</pre></code>

<p>
  Then run it:
</p>

<code><pre>
docker run -p 80:80 -d -v $(pwd):/home/app/webapp webapp
</pre></code>

<p>
  This will mount your current directory into the docker container - so all
  works like magic.
</p>
